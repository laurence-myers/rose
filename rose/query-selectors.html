<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Query Selectors :: rose</title>
    <link rel="canonical" href="https://laurence-myers.github.io/rose/rose/query-selectors.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://laurence-myers.github.io/rose">rose</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="/rose/api/">API Docs</a>
        <a class="navbar-item" href="https://github.com/laurence-myers/rose/">Code @ GitHub</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rose" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">rose</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="quick-start.html">Quick Start</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="how-it-works.html">How It Works</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="schema-introspection.html">Schema Introspection</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="constructing-and-executing-a-query.html">Constructing and Executing a Query</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="query-selectors.html">Query Selectors</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="commands.html">Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="postgresql-functions.html">PostgreSQL Functions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="connection-manager.html">Connection Manager and Database Context</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="justification.html">Why Rose?</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="alternate-projects.html">Alternate Projects</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">rose</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">rose</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">rose</a></li>
    <li><a href="query-selectors.html">Query Selectors</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Query Selectors</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>When you call <code>select()</code>, you must pass a "query selector".This is an object, whose keys are the aliases of the
selected values.The values can be one of the following types.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_column_selector"><a class="anchor" href="#_column_selector"></a>Column selector</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can pass a column metamodel as a selector. This is the simplest selector.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">select({
    title: QFilm.title
});</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_expression_selector"><a class="anchor" href="#_expression_selector"></a>Expression selector</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can construct a SQL expression to use as a selector.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">select({
    title: selectExpression(
        initcap(QFilm.title.col())
    )
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, we do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Convert the column metamodel <code>QFilm.title</code> to a column reference node</p>
</li>
<li>
<p>Pass the column reference node to the DSL function <code>initcap()</code>, which returns a function expression node.</p>
</li>
<li>
<p>Pass the function expression node to <code>selectExpression()</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_nested_one_selector"><a class="anchor" href="#_nested_one_selector"></a>Nested one selector</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can nest selected values into a single object. This is useful for converting a flat table into an object graph, or
for including data from joined tables.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">select({
    film: selectNestedOne({
        title: QFilm.title
    })
});</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_nested_many_selector"><a class="anchor" href="#_nested_many_selector"></a>Nested many selector</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can nest multiple values as objects in an array. This could be used for joining across tables, perhaps when
grouping is desired.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">select({
    id: QActor.actorId,
    films: selectNestedMany({
        title: QFilm.title
    })
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example will return an array of objects, each containing an <code>id</code> and <code>films</code>, the latter containing an array
of objects containing <code>title</code>. (The rest of the query, to join and order the tables, has been left out.)</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><em>rose</em> does not know the relationships between selected columns. To work out the "parent", rose will attempt to hash
all the other properties of the row object.</p>
</div>
<div class="paragraph">
<p>This is not foolproof - if your query has not selected enough unique columns from the "parent" table, you might find
data is grouped unexpectedly - and although a fast hashing algorithm is used, you may find it easier &amp; faster to instead
perform a second query to retrieve nested data, and join it with the parent data within your application code.</p>
</div>
<div class="paragraph">
<p>Another option is to use PostgreSQL&#8217;s JSON(B) functions to construct objects.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_rowhasher"><a class="anchor" href="#_rowhasher"></a>RowHasher</h3>
<div class="paragraph">
<p>"Parent" objects are determined by hashing the non-nested properties together.</p>
</div>
<div class="paragraph">
<p>The default hashing function uses the MD5 algorithm. You can replace the hashing function with a faster implementation,
making use of a library like [metrohash](<a href="https://www.npmjs.com/package/metrohash" class="bare">https://www.npmjs.com/package/metrohash</a>) or
[xxhash](<a href="https://www.npmjs.com/package/xxhash-wasm" class="bare">https://www.npmjs.com/package/xxhash-wasm</a>).</p>
</div>
<div class="paragraph">
<p>Replace the default RowHasher function, by calling <code>setDefaultRowHasher()</code>.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s how to use xxhash-wasm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">import * as xxhashModule from "xxhash-wasm";
import * as R from '@rosepg/rose';

const xxhashModule = await require("xxhash-wasm");

async function initialiseRose() {
    // The WASM module must be loaded asynchronously
    const xxhash = await xxhashModule();

    // At the time of writing, the types for xxhash-wasm were incorrect. You might need to use a type assertion like this.
    //const xxhash = await (xxhashModule as unknown as () =&gt; Promise&lt;xxhashModule.XXHashAPI&gt;)();

    const seed = BigInt(Date.now());

    // Define our RowHasher implementation
    function xxhashRowHasher&lt;TDataClass&gt;(
        row: TDataClass,
        propertiesToHash: string[]
    ) {
        const hash = xxhash.create64(seed);
        for (const key of propertiesToHash) {
            hash.update(`${key}=${(&lt;any&gt;row)[key]};`);
        }
        return hash.digest().toString(16);
    }

    R.setDefaultRowHasher(xxhashRowHasher);
}

// Elsewhere, in your app's startup code...
async function startApp() {
    await initialiseRose();
    // ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the rose Antora UI theme.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
